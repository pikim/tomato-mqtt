{"template":"
{%- set device_name = '' -%}
{%- set devices = states | map(attribute='entity_id') | map('device_id') | unique | reject('eq',None) | list -%}
{%- set ns = namespace(devices=[]) -%}
{%- for device in devices if device_attr(device,'name') is not none and device_attr(device,'name') in device_name -%}
  {%- set data = namespace(entities=[]) -%}
  {%- for entity in device_entities(device) | list -%}
    {%- set meta = {'uid':state_attr(entity,'uid')} -%}
    {%- set ip = state_attr(entity,'ip_address') -%}
    {%- set rule = state_attr(entity,'rule_name') -%}
    {%- set topic = state_attr(entity,'discovery') -%}
    {%- if ip %} {%- set meta = dict(meta, **{'ip_address':ip}) %} {%- endif -%}
    {%- if rule %} {%- set meta = dict(meta, **{'rule_name':rule}) %} {%- endif -%}
    {%- if topic %} {%- set meta = dict(meta, **{'discovery':topic}) %} {%- endif -%}
    {%- if 'switch.' in entity %} {%- set meta = dict(meta, **{'state':states(entity)}) %} {%- endif -%}
    {%- if meta.uid %} {%- set data.entities = data.entities + [meta] %} {%- endif -%}
  {%- endfor -%}
  {%- set ns.devices = ns.devices + [{device:{'name':device_attr(device,'name'),'entities':data.entities}}] -%}
{%- endfor -%}
{{- ns.devices -}}
"}
